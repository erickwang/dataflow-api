!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-loader")):"function"==typeof define&&define.amd?define(["exports","vega-loader"],e):e(t.df={},t.vega)}(this,function(t,e){"use strict";function n(t){return null==t?null:t.fname}function i(t){return null==t?null:t.fields}function r(t){return ce(t)?"["+t.map(r)+"]":he(t)||de(t)?JSON.stringify(t).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):t}function a(t,e,n){var i=[e].concat([].slice.call(n));console[t].apply(console,i)}function u(t){var e=t||ge,n=[],i={};return n.add=function(t){var r=e(t);return i[r]||(i[r]=1,n.push(t)),n},n.remove=function(t){var r,a=e(t);return i[a]&&(i[a]=0,(r=n.indexOf(t))>=0&&n.splice(r,1)),n},n}function s(t){return t[Te]}function o(t,e){return t[Te]=e,t}function l(t){var e=t===Object(t)?t:{data:t};return s(e)?e:o(e,We++)}function f(t){return c(t,l({}))}function c(t,e){for(var n in t)e[n]=t[n];return e}function h(t,e){return o(e,s(t))}function d(t){return t&&t.constructor===m}function m(){var t=[],e=[],n=[],i=[],r=[],a=!1;return{constructor:m,insert:function(e){for(var n=Oe(e),i=0,r=n.length;i<r;++i)t.push(n[i]);return this},remove:function(t){for(var n=Me(t)?i:e,r=Oe(t),a=0,u=r.length;a<u;++a)n.push(r[a]);return this},modify:function(t,e,i){var a={field:e,value:qe(i)};return Me(t)?(a.filter=t,r.push(a)):(a.tuple=t,n.push(a)),this},encode:function(t,e){return Me(t)?r.push({filter:t,field:e}):n.push({tuple:t,field:e}),this},reflow:function(){return a=!0,this},pulse:function(u,o){function f(t,e,n){n?t[e]=n(t):u.encode=e,a||(c[s(t)]=t)}var c,h,d,m,p,v,g;for(h=0,d=t.length;h<d;++h)u.add.push(l(t[h]));for(c={},h=0,d=e.length;h<d;++h)c[s(v=e[h])]=v;for(h=0,d=i.length;h<d;++h)p=i[h],o.forEach(function(t){p(t)&&(c[s(t)]=t)});for(g in c)u.rem.push(c[g]);for(c={},h=0,d=n.length;h<d;++h)f((m=n[h]).tuple,m.field,m.value),u.modifies(m.field);for(h=0,d=r.length;h<d;++h)m=r[h],p=m.filter,o.forEach(function(t){p(t)&&f(t,m.field,m.value)}),u.modifies(m.field);if(a)u.mod=e.length||i.length?o.filter(function(t){return c.hasOwnProperty(s(t))}):o.slice();else for(g in c)u.mod.push(c[g]);return u}}}function p(){Object.defineProperty(this,Be,{writable:!0,value:{}})}function v(t,e,n,i){this.id=++Je,this.value=t,this.stamp=-1,this.rank=-1,this.qrank=-1,this.flags=0,e&&(this._update=e),n&&this.parameters(n,i)}function g(t){return function(e){var n=this.flags;return 0===arguments.length?!!(n&t):(this.flags=e?n|t:n&~t,this)}}function y(t,e,n){this.id=++He,this.value=null,n&&(this.receive=n),t&&(this._filter=t),e&&(this._apply=e)}function _(t,e,n){return new y(t,e,n)}function x(t){var e,n,i=new Promise(function(t,i){e=t,n=i});return i.requests=0,i.done=function(){0==--i.requests&&t.runAfter(function(){t._pending=null;try{t.run(),e(t)}catch(t){n(t)}})},t._pending=i}function D(t,e,n,i,r,a){var u,s,o=Ae({},a,Xe);Me(n)||(n=qe(n)),void 0===i?u=function(e){t.touch(n(e))}:Me(i)?(s=new v(null,i,r,!1),u=function(e){var i,r=n(e);s.evaluate(e),d(i=s.value)?t.pulse(r,i,a):t.update(r,i,o)}):u=function(e){t.update(n(e),i,o)},e.apply(u)}function b(t,e,n,i,r,a){var u,s;void 0===i?s=n:(u=Me(i)?i:qe(i),(s=new v(null,i=n?function(t,e){var i=u(t,e);return n.skip()?i:n.skip(!0).value=i}:u,r,!1)).modified(a&&a.force),s.rank=0,n&&(s.skip(!0),s.value=n.value,s.targets().add(n))),e.targets().add(s)}function w(t,e,n){this.dataflow=t,this.stamp=null==e?-1:e,this.add=[],this.rem=[],this.mod=[],this.fields=null,this.encode=n||null}function k(t,e){return t?function(n,i){return t(n,i)&&e(n,i)}:e}function O(t,e){var n=[];return $e(t,e,function(t){n.push(t)}),n}function M(t,e){var n={};return t.visit(e,function(t){n[s(t)]=1}),function(t){return n[s(t)]?null:t}}function E(t,e,n,i){var r,a,u,s,o,l=this,f=0;for(this.dataflow=t,this.stamp=e,this.fields=null,this.encode=i||null,this.pulses=n,u=0,s=n.length;u<s;++u)if((r=n[u]).stamp===e){if(r.fields){a=l.fields||(l.fields={});for(o in r.fields)a[o]=1}r.changed(l.ADD)&&(f|=l.ADD),r.changed(l.REM)&&(f|=l.REM),r.changed(l.MOD)&&(f|=l.MOD)}this.changes=f}function q(t){this.cmp=t,this.nodes=[]}function N(t,e,n,i){var r,a,u;for(r=t[n];n>e&&i(r,a=t[u=n-1>>1])<0;)t[n]=a,n=u;return t[n]=r}function A(t,e,n){for(var i,r=e,a=t.length,u=t[e],s=2*e+1;s<a;)(i=s+1)<a&&n(t[s],t[i])>=0&&(s=i),t[e]=t[s],s=2*(e=s)+1;return t[e]=u,N(t,r,e,n)}function F(){this._log=we(),this.logLevel(xe),this._clock=0,this._rank=0;try{this._loader=e.loader()}catch(t){}this._touched=u(ve),this._pulses={},this._pulse=null,this._heap=new q(function(t,e){return t.qrank-e.qrank}),this._postrun=[]}function R(t){return function(){return this._log[t].apply(this,arguments)}}function S(t,e){v.call(this,t,null,e)}function P(t,e){return e=Ie(Oe(e)),t.filter(t=>!e[t.name])}function j(t,e){return t.map(t=>{let n=t.name;return e[n]?Ae({},t,e[n]):t})}function C(t){return function(e){for(var n=t.length,i=1,r=String(t[0](e));i<n;++i)r+="|"+t[i](e);return r}}function U(t){return t&&t.length?1===t.length?t[0]:C(t):function(){return""}}function L(t,e,n){return n||t+(e?"_"+e:"")}function z(t,e){return on[t](e)}function I(t){return function(e){var n=Ae({init:"",add:"",rem:"",idx:0},t);return n.out=e||t.name,n}}function $(t,e){return t.idx-e.idx}function T(t,e){function n(t,i){function r(e){t[e]||n(t,t[e]=on[e]())}return i.req&&i.req.forEach(r),e&&i.str&&i.str.forEach(r),t}var i,r=t.reduce(n,t.reduce(function(t,e){return t[e.name]=e,t},{})),a=[];for(i in r)a.push(r[i]);return a.sort($)}function W(t,e){var n=e||ge,i="var cell = this.cell; this.valid = 0; this.missing = 0;",r="this.cell = cell; this.init();",a="if(v==null){++this.missing; return;} if(v!==v) return; ++this.valid;",u="if(v==null){--this.missing; return;} if(v!==v) return; --this.valid;",s="var cell = this.cell;";return T(t,!0).forEach(function(t){i+=t.init,a+=t.add,u+=t.rem}),t.slice().sort($).forEach(function(t){s+="t['"+t.out+"']="+t.set+";"}),s+="return t;",r=Function("cell",r),r.prototype.init=Function(i),r.prototype.add=Function("v","t",a),r.prototype.rem=Function("v","t",u),r.prototype.set=Function("t",s),r.prototype.get=n,r.fields=t.map(function(t){return t.out}),r}function B(t){return null===t?NaN:+t}function G(t){return function(e,n){return dn(t(e),n)}}function J(t){var e=t.length,n=Dn(t),i=(n[2]-n[0])/1.34;return 1.06*Math.min(Math.sqrt(vn(t)),i)*Math.pow(e,-.2)}function K(t){this._key=t?me(t):s,this.reset()}function Q(t){S.call(this,null,t),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}function H(t){S.call(this,null,t)}function V(t){S.call(this,[],t)}function X(t){v.call(this,null,Y,t)}function Y(t){return this.value&&!t.modified()?this.value:Ee(t.fields,t.orders)}function Z(t){S.call(this,null,t)}function tt(t,e,n){switch(e){case"upper":t=t.toUpperCase();break;case"lower":t=t.toLowerCase()}return t.match(n)}function et(t){S.call(this,null,t)}function nt(t,e,n,i){for(var r,a,u=[],s={},o=t.length,f=0;f<o;++f)for(s[e]=a=t[f],r=0;r<o;++r)s[n]=t[r],i(s)&&(u.push(l(s)),(s={})[e]=a);return u}function it(t,e){var n=t[An];qn.hasOwnProperty(n)||le("Unknown distribution function: "+n);var i=qn[n]();for(var r in t)r===Fn?i.data((t.from||e()).map(t[r])):r===Nn?i[r](t[r].map(function(t){return it(t,e)})):typeof i[r]===An&&i[r](t[r]);return i}function rt(t){S.call(this,null,t)}function at(t){return function(){return t.materialize(t.SOURCE).source}}function ut(t){S.call(this,[1/0,-1/0],t)}function st(t,e){v.call(this,t),this.parent=e}function ot(t){S.call(this,{},t),this._keys=Se();var e=this._targets=[];e.active=0,e.forEach=function(t){for(var n=0,i=e.active;n<i;++n)t(e[n],n,e)}}function lt(t){v.call(this,null,ft,t)}function ft(t){return this.value&&!t.modified()?this.value:ce(t.name)?Oe(t.name).map(function(t){return me(t)}):me(t.name,t.as)}function ct(t){S.call(this,Se(),t)}function ht(t){S.call(this,{},t)}function dt(t){return t.fields.join("|")}function mt(t){S.call(this,null,t)}function pt(t){S.call(this,[],t)}function vt(t){S.call(this,[],t)}function gt(t){var e,n=t.method||Cn.value;if(null!=Cn[n])return n===Cn.value?(e=void 0!==t.value?t.value:0,function(){return e}):Cn[n];le("Unrecognized imputation method: "+n)}function yt(t){var e=t.field;return function(t){return t?e(t):NaN}}function _t(t,e,n,i){var r,a,u,s,o,l,f,c,h=[],d=i?i.slice():[],m={},p={};for(d.forEach(function(t,e){m[t]=e+1}),s=0,f=t.length;s<f;++s)l=n(c=t[s]),o=m[l]||(m[l]=d.push(l)),(u=p[a=(r=e?e.map(function(t){return t(c)}):Un)+""])||(u=p[a]=[],h.push(u),u.values=r),u[o-1]=c;return h.domain=d,h}function xt(t){Q.call(this,t)}function Dt(t){v.call(this,null,bt,t)}function bt(t){return this.value&&!t.modified()?this.value:Ce(t.fields)}function wt(t){S.call(this,{},t)}function kt(t){v.call(this,null,Ot,t)}function Ot(t){if(this.value&&!t.modified())return this.value;var e,n,i,r=1/0,a=-1/0,u=t.extents;for(e=0,n=u.length;e<n;++e)(i=u[e])[0]<r&&(r=i[0]),i[1]>a&&(a=i[1]);return[r,a]}function Mt(t){v.call(this,null,Et,t)}function Et(t){return this.value&&!t.modified()?this.value:t.values.reduce(function(t,e){return t.concat(e)},[])}function qt(t){S.call(this,null,t)}function Nt(t){ot.call(this,t)}function At(t){S.call(this,null,t)}function Ft(t,e){return t?t.map(function(t,i){return e[i]||n(t)}):null}function Rt(t,e,n,i){for(var r=0,a=n.length;r<a;++r)e[i[r]]=n[r](t);return e}function St(t){S.call(this,null,t)}function Pt(t){S.call(this,null,t)}function jt(t){S.call(this,[],t),this.count=0}function Ct(t){S.call(this,null,t)}function Ut(t){S.call(this,null,t),this.modified(!0)}function Lt(t){S.call(this,Se(),t)}function zt(t){S.call(this,null,t)}function It(t,e,n,i){var r=zn[t](e,n);return{init:r.init||ye,update:function(t,e){e[i]=r.next(t)}}}function $t(t){function e(t){Oe(i(t)).forEach(function(t){c[t]=1})}var r=this,a=Oe(t.ops),u=Oe(t.fields),s=Oe(t.params),o=Oe(t.as),l=r.outputs=[],f=r.windows=[],c={},h={},d=!0,m=[],p=[];e(t.sort),a.forEach(function(t,i){var r=u[i],a=n(r),c=L(t,a,o[i]);if(e(r),l.push(c),zn.hasOwnProperty(t))f.push(It(t,u[i],s[i],c));else{if(null==r&&"count"!==t&&le("Null aggregate field specified."),"count"===t)return void m.push(c);d=!1;var v=h[a];v||((v=h[a]=[]).field=r,p.push(v)),v.push(z(t,c))}}),(m.length||p.length)&&(r.cell=Tt(p,m,d)),r.inputs=Object.keys(c)}function Tt(t,e,n){t=t.map(function(t){return W(t,t.field)});var i={num:0,agg:null,store:!1,count:e};if(!n)for(var r=t.length,a=i.agg=Array(r),u=0;u<r;++u)a[u]=new t[u](i);if(i.store)var s=i.data=new K;return i.add=function(t){if(i.num+=1,!n){s&&s.add(t);for(var e=0;e<r;++e)a[e].add(a[e].get(t),t)}},i.rem=function(t){if(i.num-=1,!n){s&&s.rem(t);for(var e=0;e<r;++e)a[e].rem(a[e].get(t),t)}},i.set=function(t){var r,u;for(s&&s.values(),r=0,u=e.length;r<u;++r)t[e[r]]=i.num;if(!n)for(r=0,u=a.length;r<u;++r)a[r].set(t)},i.init=function(){i.num=0,s&&s.reset();for(var t=0;t<r;++t)a[t].init()},i}function Wt(t){S.call(this,{},t),this._mlen=0,this._mods=[]}function Bt(t,e,n){var i=n.sort,r=i&&!n.ignorePeers,a=n.frame||[null,0],u=t.data(i),s=u.length,o=0,l=r?mn(i):null,f={i0:0,i1:0,p0:0,p1:0,index:0,data:u,compare:i||qe(-1)};for(e.init();o<s;++o)Gt(f,a,o,s),r&&Jt(f,l),e.update(f,u[o])}function Gt(t,e,n,i){t.p0=t.i0,t.p1=t.i1,t.i0=null==e[0]?0:Math.max(0,n-Math.abs(e[0])),t.i1=null==e[1]?i:Math.min(i,n+Math.abs(e[1])+1),t.index=n}function Jt(t,e){var n=t.i0,i=t.i1-1,r=t.compare,a=t.data,u=a.length-1;n>0&&!r(a[n],a[n-1])&&(t.i0=e.left(a,a[n])),i<u&&!r(a[i],a[i+1])&&(t.i1=e.right(a,a[i]))}function Kt(t){const e=t.array?"array":t.type;return Qn[e](t)}function Qt(t){if(je(t)){let e=t+"",n=e.lastIndexOf("/");return e.slice(1,n)}return ze(t)}function Ht(t){const e=[],n=[];return t.forEach(function(t){t&&de(t)||le(`Invalid comparator field: '${t+""}'.`);let i=Bn;"-"===t[0]?(i=Gn,t=t.slice(1)):"+"===t[0]&&(t=t.slice(1)),e.push(t),n.push(i)}),{fields:e,orders:n}}function Vt(t){return t&&Me(t.toObject)&&(t=t.toObject()),he(t)&&!Me(t)?oe(t.accessor,t.fields,t.as):null}function Xt(t){return t&&Me(t.toObject)&&(t=t.toObject()),de(t)?me(t):he(t)&&!Me(t)?Me(t.accessor)?oe(t.accessor,t.fields,t.as):me(t.field,t.as):null}function Yt(t,e){let n=[],i=[],r=[],a=[];for(let u of t){Me(u.toObject)&&(u=u.toObject());let t=ze(u.op);e.hasOwnProperty(t)||le(`Invalid operation: ${t}.`),n.push(t),a.push(ke(u.param)),i.push(Xt(u.field)),r.push(u.as?ze(u.as):null)}return a.every(t=>null==t)?{ops:n,fields:i,as:r}:{ops:n,fields:i,as:r,params:a}}function Zt(t,e,n){const i={},r={create:(n,r)=>te(n,r,t,e,i),metadata:()=>n};return ee(r,e,i),r}function te(t,e,n,i,r){let a=Ae({},e);for(let n of i){let i=n.name,u=r[n.alias||n.name],s=void 0!==u;if(n.init&&!s){let u=Ae({},e);for(let t in n.init.params)u[t]=r[n.init.params[t]];a[i]=t.add(Wn[n.init.type],u)}else if(s)if(n.proxy)for(let t in u)a[t]=u[t];else a[i]=u}return t.add(Wn[n],a)}function ee(t,e,n){for(let i of e){const e=i.alias||i.name,r=Kt(i);t[e]=function(i){return arguments.length?(n[e]=r(i),t):n[e]}}}function ne(t,e){let n=null,i=null,r=null;const a={[Yn]:()=>i,values:function(){return r.value},on:t=>(un.addDataListener(r,t),a),off:t=>(un.removeDataListener(r,t),a)};return t||(a.insert=function(t){return un.pulse(n,un.changeset().insert(t)).run(),a},a.remove=function(t){return un.pulse(n,un.changeset().remove(t)).run(),a}),function(e){let a,u,s,o,l,f,c,h,d=!0,m=[Xn()];for(a=0,u=e.length;a<u;++a)o=(s=e[a]).metadata(),d||o.source||(d=!0,m.push(Xn())),m.push(s),o.generates&&(l=!0),o.modifies&&!l&&(f=!0),o.source?d=!0:o.changes&&(d=!1);for(d||m.push(Xn()),t&&(1===(c=Oe(t).map(t=>t[Yn]())).length&&(c=c[0]),h=un.add(Pt,{derive:f,pulse:c})),a=0,u=m.length;a<u;++a)c={pulse:h},h=m[a].create(un,c),0===a&&(n=h);i=h,r=un.add(Ut,{pulse:h}),un.run()}(Oe(e)),a}function ie(t){const e=t||{},n={toObject:()=>e};re(n,e,"as");for(let t=1,i=arguments.length;t<i;++t)re(n,e,arguments[t]);return n}function re(t,e,n){t[n]=function(i){return arguments.length?(e[n]=i,t):e[n]}}function ae(t){return()=>ie({op:t})}function ue(t){return e=>ie({op:t},"field").field(e)}function se(t){return(e,n)=>ie({op:t},"field","param").field(e).param(n)}var oe=function(t,e,n){return t.fields=e||[],t.fname=n,t},le=function(t){throw Error(t)},fe=function(t){function e(){a.push(l+t.substring(n,i)),l="",n=i+1}var n,i,r,a=[],u=null,s=0,o=t.length,l="";for(t+="",n=i=0;i<o;++i)if("\\"===(r=t[i]))l+=t.substring(n,i),n=++i;else if(r===u)e(),u=null,s=-1;else{if(u)continue;n===s&&'"'===r?(n=i+1,u=r):n===s&&"'"===r?(n=i+1,u=r):"."!==r||s?"["===r?(i>n&&e(),s=n=i+1):"]"===r&&(s||le("Access path missing open bracket: "+t),s>0&&e(),s=0,n=i+1):i>n?e():n=i+1}return s&&le("Access path missing closing bracket: "+t),u&&le("Access path missing closing quote: "+t),i>n&&(i++,e()),a},ce=Array.isArray,he=function(t){return t===Object(t)},de=function(t){return"string"==typeof t},me=function(t,e){var n=fe(t),i="return _["+n.map(r).join("][")+"];";return oe(Function("_",i),[t=1===n.length?n[0]:t],e||t)},pe=[],ve=me("id"),ge=oe(function(t){return t},pe,"identity"),ye=oe(function(){return 0},pe,"zero"),_e=(oe(function(){return 1},pe,"one"),oe(function(){return!0},pe,"true")),xe=(oe(function(){return!1},pe,"false"),1),De=3,be=4,we=function(t){var e=t||0;return{level:function(t){return arguments.length?(e=+t,this):e},error:function(){return e>=xe&&a("error","ERROR",arguments),this},warn:function(){return e>=2&&a("warn","WARN",arguments),this},info:function(){return e>=De&&a("log","INFO",arguments),this},debug:function(){return e>=be&&a("log","DEBUG",arguments),this}}},ke=function(t){return null==t||""===t?null:+t},Oe=function(t){return null!=t?ce(t)?t:[t]:[]},Me=function(t){return"function"==typeof t},Ee=function(t,e){var n,a,u,s,o,l,f,c,h,d=[],m=(t=Oe(t)).map(function(t,e){return null==t?null:(d.push(e),Me(t)?t:fe(t).map(r).join("]["))}),p=d.length-1,v=Oe(e),g="var u,v;return ";if(p<0)return null;for(a=0;a<=p;++a)u=m[n=d[a]],Me(u)?(s="(u=this."+(l="f"+n)+"(a))",o="(v=this."+l+"(b))",(f=f||{})[l]=u):(s="(u=a["+u+"])",o="(v=b["+u+"])"),l="((v=v instanceof Date?+v:v),(u=u instanceof Date?+u:u))","descending"!==v[n]?(h=1,c=-1):(h=-1,c=1),g+="("+s+"<"+o+"||u==null)&&v!=null?"+c+":(u>v||v==null)&&u!=null?"+h+":"+l+"!==u&&v===v?"+c+":v!==v&&u===u?"+h+(n<p?":":":0");return u=Function("a","b",g+";"),f&&(u=u.bind(f)),t=t.reduce(function(t,e){return Me(e)?(i(e)||[]).forEach(function(e){t[e]=1}):null!=e&&(t[e+""]=1),t},{}),oe(u,Object.keys(t))},qe=function(t){return Me(t)?t:function(){return t}},Ne=function(t,e){function n(){e(r),i=r=null}var i,r;return function(e){r=e,i&&clearTimeout(i),i=setTimeout(n,t)}},Ae=function(t){for(var e,n,i=1,r=arguments.length;i<r;++i){e=arguments[i];for(n in e)t[n]=e[n]}return t},Fe=function(t,e){var n,i,r,a,u,s=-1,o=t.length;if(null==e){for(;++s<o;)if(null!=(i=t[s])&&i>=i){n=r=i;break}for(a=u=s;++s<o;)null!=(i=t[s])&&(n>i&&(n=i,a=s),r<i&&(r=i,u=s))}else{for(;++s<o;)if(null!=(i=e(t[s],s,t))&&i>=i){n=r=i;break}for(a=u=s;++s<o;)null!=(i=e(t[s],s,t))&&(n>i&&(n=i,a=s),r<i&&(r=i,u=s))}return[a,u]},Re={},Se=function(t){function e(t){return r.hasOwnProperty(t)&&r[t]!==Re}var n,i,r={};return n={size:0,empty:0,object:r,has:e,get:function(t){return e(t)?r[t]:void 0},set:function(t,i){return e(t)||(++n.size,r[t]===Re&&--n.empty),r[t]=i,this},delete:function(t){return e(t)&&(--n.size,++n.empty,r[t]=Re),this},clear:function(){n.size=n.empty=0,n.object=r={}},test:function(t){return arguments.length?(i=t,n):i},clean:function(){var t,e,a={},u=0;for(t in r)(e=r[t])===Re||i&&i(e)||(a[t]=e,++u);n.size=u,n.empty=0,n.object=r=a}},t&&Object.keys(t).forEach(function(e){n.set(e,t[e])}),n},Pe=function(t,e){var n=t.prototype=Object.create(e.prototype);return n.constructor=t,n},je=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},Ce=function(t){var e=(t=t?Oe(t):t)&&t.length?Function("_","return ''+"+t.map(function(t){return"_["+fe(t).map(r).join("][")+"]"}).join("+'|'+")+";"):function(){return""};return oe(e,t,"key")},Ue=function(t,e,n,i){var r=e.length,a=n.length;if(!a)return e;if(!r)return n;for(var u=i||new e.constructor(r+a),s=0,o=0,l=0;s<r&&o<a;++l)u[l]=t(e[s],n[o])>0?n[o++]:e[s++];for(;s<r;++s,++l)u[l]=e[s];for(;o<a;++o,++l)u[l]=n[o];return u},Le=function(t){return null==t||""===t?null:!(!t||"false"===t||"0"===t)&&!!t},ze=function(t){return null==t||""===t?null:t+""},Ie=function(t){for(var e={},n=0,i=t.length;n<i;++n)e[t[n]]=1;return e},$e=function(t,e,n){if(t){var i,r=0,a=t.length;if(e)for(;r<a;++r)(i=e(t[r]))&&n(i,r,t);else t.forEach(n)}},Te=Symbol("vega_id"),We=1,Be="_:mod:_",Ge=p.prototype;Ge.set=function(t,e,n,i){var r=this,a=r[t],u=r[Be];return null!=e&&e>=0?(a[e]!==n||i)&&(a[e]=n,u[e+":"+t]=-1,u[t]=-1):(a!==n||i)&&(r[t]=n,u[t]=ce(n)?1+n.length:-1),r},Ge.modified=function(t,e){var n,i=this[Be];if(!arguments.length){for(n in i)if(i[n])return!0;return!1}if(ce(t)){for(n=0;n<t.length;++n)if(i[t[n]])return!0;return!1}return null!=e&&e>=0?e+1<i[t]||!!i[e+":"+t]:!!i[t]},Ge.clear=function(){return this[Be]={},this};var Je=0,Ke=new p,Qe=v.prototype;Qe.targets=function(){return this._targets||(this._targets=u(ve))},Qe.set=function(t){return this.value!==t?(this.value=t,1):0},Qe.skip=g(1),Qe.modified=g(2),Qe.parameters=function(t,e){function n(t,n,i){i instanceof v?(i!==s&&(e&&i.targets().add(s),f.push(i)),l.push({op:i,name:t,index:n})):o.set(t,n,i)}e=!1!==e;var i,r,a,u,s=this,o=s._argval=s._argval||new p,l=s._argops=s._argops||[],f=[];for(i in t)if(r=t[i],"pulse"===i)Oe(r).forEach(function(t){t instanceof v?t!==s&&(t.targets().add(s),f.push(t)):le("Pulse parameters must be operator instances.")}),s.source=r;else if(ce(r))for(o.set(i,-1,Array(a=r.length)),u=0;u<a;++u)n(i,u,r[u]);else n(i,-1,r);return this.marshall().clear(),f},Qe.marshall=function(t){var e,n,i,r,a,u=this._argval||Ke,s=this._argops;if(s&&(i=s.length))for(n=0;n<i;++n)a=(r=(e=s[n]).op).modified()&&r.stamp===t,u.set(e.name,e.index,r.value,a);return u},Qe.evaluate=function(t){if(this._update){var e=this.marshall(t.stamp),n=this._update(e,t);if(e.clear(),n!==this.value)this.value=n;else if(!this.modified())return t.StopPropagation}},Qe.run=function(t){if(t.stamp<=this.stamp)return t.StopPropagation;var e;return this.skip()?(this.skip(!1),e=0):e=this.evaluate(t),this.stamp=t.stamp,this.pulse=e,e||t};var He=0,Ve=y.prototype;Ve._filter=_e,Ve._apply=ge,Ve.targets=function(){return this._targets||(this._targets=u(ve))},Ve.consume=function(t){return arguments.length?(this._consume=!!t,this):!!this._consume},Ve.receive=function(t){if(this._filter(t)){for(var e=this.value=this._apply(t),n=this._targets,i=n?n.length:0,r=0;r<i;++r)n[r].receive(e);this._consume&&(t.preventDefault(),t.stopPropagation())}},Ve.filter=function(t){var e=_(t);return this.targets().add(e),e},Ve.apply=function(t){var e=_(null,t);return this.targets().add(e),e},Ve.merge=function(){var t=_();this.targets().add(t);for(var e=0,n=arguments.length;e<n;++e)arguments[e].targets().add(t);return t},Ve.throttle=function(t){var e=-1;return this.filter(function(){var n=Date.now();return n-e>t?(e=n,1):0})},Ve.debounce=function(t){var e=_();return this.targets().add(_(null,null,Ne(t,function(t){var n=t.dataflow;e.receive(t),n&&n.run&&n.run()}))),e},Ve.between=function(t,e){var n=!1;return t.targets().add(_(null,null,function(){n=!0})),e.targets().add(_(null,null,function(){n=!1})),this.filter(function(){return n})};var Xe={skip:!0},Ye={},Ze=w.prototype;Ze.StopPropagation=Ye,Ze.ADD=1,Ze.REM=2,Ze.MOD=4,Ze.ADD_REM=3,Ze.ADD_MOD=5,Ze.ALL=7,Ze.REFLOW=8,Ze.SOURCE=16,Ze.NO_SOURCE=32,Ze.NO_FIELDS=64,Ze.fork=function(t){return new w(this.dataflow).init(this,t)},Ze.addAll=function(){var t=this;return this.source&&this.source.length!==this.add.length?(t=new w(this.dataflow).init(this),t.add=t.source,t):t},Ze.init=function(t,e){var n=this;return n.stamp=t.stamp,n.encode=t.encode,!t.fields||64&e||(n.fields=t.fields),1&e?(n.addF=t.addF,n.add=t.add):(n.addF=null,n.add=[]),2&e?(n.remF=t.remF,n.rem=t.rem):(n.remF=null,n.rem=[]),4&e?(n.modF=t.modF,n.mod=t.mod):(n.modF=null,n.mod=[]),32&e?(n.srcF=null,n.source=null):(n.srcF=t.srcF,n.source=t.source),n},Ze.runAfter=function(t){this.dataflow.runAfter(t)},Ze.changed=function(t){var e=t||7;return 1&e&&this.add.length||2&e&&this.rem.length||4&e&&this.mod.length},Ze.reflow=function(t){if(t)return this.fork(7).reflow();var e=this.add.length,n=this.source&&this.source.length;return n&&n!==e&&(this.mod=this.source,e&&this.filter(4,M(this,1))),this},Ze.modifies=function(t){var e=Oe(t),n=this.fields||(this.fields={});return e.forEach(function(t){n[t]=!0}),this},Ze.modified=function(t){var e=this.fields;return!(!this.mod.length||!e)&&(arguments.length?ce(t)?t.some(function(t){return e[t]}):e[t]:!!e)},Ze.filter=function(t,e){var n=this;return 1&t&&(n.addF=k(n.addF,e)),2&t&&(n.remF=k(n.remF,e)),4&t&&(n.modF=k(n.modF,e)),16&t&&(n.srcF=k(n.srcF,e)),n},Ze.materialize=function(t){var e=this;return 1&(t=t||7)&&e.addF&&(e.add=O(e.add,e.addF),e.addF=null),2&t&&e.remF&&(e.rem=O(e.rem,e.remF),e.remF=null),4&t&&e.modF&&(e.mod=O(e.mod,e.modF),e.modF=null),16&t&&e.srcF&&(e.source=e.source.filter(e.srcF),e.srcF=null),e},Ze.visit=function(t,e){var n,i,r=this,a=e;return 16&t?($e(r.source,r.srcF,a),r):(1&t&&$e(r.add,r.addF,a),2&t&&$e(r.rem,r.remF,a),4&t&&$e(r.mod,r.modF,a),8&t&&(n=r.source)&&((i=r.add.length+r.mod.length)===n.length||(i?$e(n,M(r,5),a):$e(n,r.srcF,a))),r)};var tn=Pe(E,w);tn.fork=function(t){var e=new w(this.dataflow).init(this,t&this.NO_FIELDS);return void 0!==t&&(t&e.ADD&&this.visit(e.ADD,function(t){return e.add.push(t)}),t&e.REM&&this.visit(e.REM,function(t){return e.rem.push(t)}),t&e.MOD&&this.visit(e.MOD,function(t){return e.mod.push(t)})),e},tn.changed=function(t){return this.changes&t},tn.modified=function(t){var e=this,n=e.fields;return n&&e.changes&e.MOD?ce(t)?t.some(function(t){return n[t]}):n[t]:0},tn.filter=function(){le("MultiPulse does not support filtering.")},tn.materialize=function(){le("MultiPulse does not support materialization.")},tn.visit=function(t,e){var n=this,i=n.pulses,r=i.length,a=0;if(t&n.SOURCE)for(;a<r;++a)i[a].visit(t,e);else for(;a<r;++a)i[a].stamp===n.stamp&&i[a].visit(t,e);return n};var en={skip:!1,force:!1},nn=q.prototype;nn.size=function(){return this.nodes.length},nn.clear=function(){return this.nodes=[],this},nn.peek=function(){return this.nodes[0]},nn.push=function(t){var e=this.nodes;return e.push(t),N(e,0,e.length-1,this.cmp)},nn.pop=function(){var t,e=this.nodes,n=e.pop();return e.length?(t=e[0],e[0]=n,A(e,0,this.cmp)):t=n,t},nn.replace=function(t){var e=this.nodes,n=e[0];return e[0]=t,A(e,0,this.cmp),n},nn.pushpop=function(t){var e=this.nodes,n=e[0];return e.length&&this.cmp(n,t)<0&&(e[0]=t,t=n,A(e,0,this.cmp)),t};var rn=F.prototype;rn.stamp=function(){return this._clock},rn.loader=function(t){return arguments.length?(this._loader=t,this):this._loader},rn.cleanThreshold=1e4,rn.add=function(t,e,n,i){var r,a=1;return t instanceof v?r=t:t&&t.prototype instanceof v?r=new t:Me(t)?r=new v(null,t):(a=0,r=new v(t,e)),this.rank(r),a&&(i=n,n=e),n&&this.connect(r,r.parameters(n,i)),this.touch(r),r},rn.connect=function(t,e){var n,i,r=t.rank;for(n=0,i=e.length;n<i;++n)if(r<e[n].rank)return void this.rerank(t)},rn.rank=function(t){t.rank=++this._rank},rn.rerank=function(t){for(var e,n,i,r=[t];r.length;)if(this.rank(e=r.pop()),n=e._targets)for(i=n.length;--i>=0;)r.push(e=n[i]),e===t&&le("Cycle detected in dataflow graph.")},rn.pulse=function(t,e,n){this.touch(t,n||en);var i=new w(this,this._clock+(this._pulse?0:1)),r=t.pulse&&t.pulse.source||[];return i.target=t,this._pulses[t.id]=e.pulse(i,r),this},rn.touch=function(t,e){var n=e||en;return this._pulse?this._enqueue(t):this._touched.add(t),n.skip&&t.skip(!0),this},rn.update=function(t,e,n){var i=n||en;return(t.set(e)||i.force)&&this.touch(t,i),this},rn.changeset=m,rn.ingest=function(t,n,i){return this.pulse(t,this.changeset().insert(e.read(n,i)))},rn.request=function(t,e,n){var i=this,r=i._pending||x(i);r.requests+=1,i.loader().load(e,{context:"dataflow"}).then(function(e){i.ingest(t,e,n)},function(t){i.error("Loading failed",e,t)}).catch(function(t){i.error("Data ingestion failed",e,t)}).then(r.done,r.done)},rn.events=function(t,e,n,i){for(var r,a=this,u=_(n,i),s=0,o=(r="string"==typeof t&&"undefined"!=typeof document?document.querySelectorAll(t):Oe(t)).length;s<o;++s)r[s].addEventListener(e,function(t){t.dataflow=a;try{u.receive(t)}catch(t){a.error(t)}finally{a.run()}});return u},rn.on=function(t,e,n,i,r){return(t instanceof v?b:D)(this,t,e,n,i,r),this},rn.run=function(t){var e,n,i,r,a=this,s=0,o=a.logLevel();if(a._pending)return a.info("Awaiting requests, delaying dataflow run."),0;if(a._pulse)return a.error("Dataflow invoked recursively. Use the runAfter method to queue invocation."),0;if(!a._touched.length)return a.info("Dataflow invoked, but nothing to do."),0;a._pulse=new w(a,++a._clock,t),o>=De&&(i=Date.now(),a.debug("-- START PROPAGATION ("+a._clock+") -----")),a._touched.forEach(function(t){a._enqueue(t,!0)}),a._touched=u(ve);try{for(;a._heap.size()>0;)(e=a._heap.pop()).rank===e.qrank?(n=e.run(a._getPulse(e,t)),o>=be&&a.debug(e.id,n===Ye?"STOP":n,e),n!==Ye&&(a._pulse=n,e._targets&&e._targets.forEach(function(t){a._enqueue(t)})),++s):a._enqueue(e,!0)}catch(t){r=t}if(a._pulses={},a._pulse=null,o>=De&&(i=Date.now()-i,a.info("> Pulse "+a._clock+": "+s+" operators; "+i+"ms")),r&&(a._postrun=[],a.error(r)),a._onrun)try{a._onrun(a,s,r)}catch(t){a.error(t)}if(a._postrun.length){var l=a._postrun;a._postrun=[],l.forEach(function(t){try{t(a)}catch(t){a.error(t)}})}return s},rn.runAsync=function(){return this._pending||Promise.resolve(this.run())},rn.runAfter=function(t,e){if(this._pulse||e)this._postrun.push(t);else try{t(this)}catch(t){this.error(t)}},rn._enqueue=function(t,e){var n=!this._pulses[t.id];n&&(this._pulses[t.id]=this._pulse),(n||e)&&(t.qrank=t.rank,this._heap.push(t))},rn._getPulse=function(t,e){var n,i=t.source,r=this._clock;return i&&ce(i)?(n=i.map(function(t){return t.pulse}),new E(this,r,n,e)):(i=i&&i.pulse,n=this._pulses[t.id],i&&i!==Ye&&(i.stamp===r&&n.target!==t?n=i:n.source=i.source),n)},rn.error=R("error"),rn.warn=R("warn"),rn.info=R("info"),rn.debug=R("debug"),rn.logLevel=R("level");var an=Pe(S,v);an.run=function(t){if(t.stamp<=this.stamp)return t.StopPropagation;var e;return this.skip()?this.skip(!1):e=this.evaluate(t),(e=e||t)!==t.StopPropagation&&(this.pulse=e),this.stamp=t.stamp,e},an.evaluate=function(t){var e=this.marshall(t.stamp),n=this.transform(e,t);return e.clear(),n},an.transform=function(){};const un=(new F).logLevel(2);let sn=[];un.addDataListener=function(t,e){sn.push({op:t,fn:e})},un.removeDataListener=function(t,e){let n=null;for(let i of sn)if(i.op===t&&i.fn===e){n=i;break}n&&(sn=sn.filter(t=>t!==n))},un._onrun=function(){let t=un.stamp(),e=sn.filter(e=>e.op.stamp===t);e.length&&setTimeout(function(){e.forEach(t=>t.fn(t.op.value))},0)};var on={values:I({name:"values",init:"cell.store = true;",set:"cell.data.values()",idx:-1}),count:I({name:"count",set:"cell.num"}),missing:I({name:"missing",set:"this.missing"}),valid:I({name:"valid",set:"this.valid"}),sum:I({name:"sum",init:"this.sum = 0;",add:"this.sum += v;",rem:"this.sum -= v;",set:"this.sum"}),mean:I({name:"mean",init:"this.mean = 0;",add:"var d = v - this.mean; this.mean += d / this.valid;",rem:"var d = v - this.mean; this.mean -= this.valid ? d / this.valid : this.mean;",set:"this.mean"}),average:I({name:"average",set:"this.mean",req:["mean"],idx:1}),variance:I({name:"variance",init:"this.dev = 0;",add:"this.dev += d * (v - this.mean);",rem:"this.dev -= d * (v - this.mean);",set:"this.valid > 1 ? this.dev / (this.valid-1) : 0",req:["mean"],idx:1}),variancep:I({name:"variancep",set:"this.valid > 1 ? this.dev / this.valid : 0",req:["variance"],idx:2}),stdev:I({name:"stdev",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid-1)) : 0",req:["variance"],idx:2}),stdevp:I({name:"stdevp",set:"this.valid > 1 ? Math.sqrt(this.dev / this.valid) : 0",req:["variance"],idx:2}),stderr:I({name:"stderr",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid * (this.valid-1))) : 0",req:["variance"],idx:2}),distinct:I({name:"distinct",set:"cell.data.distinct(this.get)",req:["values"],idx:3}),ci0:I({name:"ci0",set:"cell.data.ci0(this.get)",req:["values"],idx:3}),ci1:I({name:"ci1",set:"cell.data.ci1(this.get)",req:["values"],idx:3}),median:I({name:"median",set:"cell.data.q2(this.get)",req:["values"],idx:3}),q1:I({name:"q1",set:"cell.data.q1(this.get)",req:["values"],idx:3}),q3:I({name:"q3",set:"cell.data.q3(this.get)",req:["values"],idx:3}),argmin:I({name:"argmin",init:"this.argmin = null;",add:"if (v < this.min) this.argmin = t;",rem:"if (v <= this.min) this.argmin = null;",set:"this.argmin || cell.data.argmin(this.get)",req:["min"],str:["values"],idx:3}),argmax:I({name:"argmax",init:"this.argmax = null;",add:"if (v > this.max) this.argmax = t;",rem:"if (v >= this.max) this.argmax = null;",set:"this.argmax || cell.data.argmax(this.get)",req:["max"],str:["values"],idx:3}),min:I({name:"min",init:"this.min = null;",add:"if (v < this.min || this.min === null) this.min = v;",rem:"if (v <= this.min) this.min = NaN;",set:"this.min = (isNaN(this.min) ? cell.data.min(this.get) : this.min)",str:["values"],idx:4}),max:I({name:"max",init:"this.max = null;",add:"if (v > this.max || this.max === null) this.max = v;",rem:"if (v >= this.max) this.max = NaN;",set:"this.max = (isNaN(this.max) ? cell.data.max(this.get) : this.max)",str:["values"],idx:4})},ln=Object.keys(on),fn=function(t){var e,n,i,r,a,u,s,o,l=t.maxbins||20,f=t.base||10,c=Math.log(f),h=t.divide||[5,2],d=t.extent[0],m=t.extent[1],p=m-d;if(t.step)e=t.step;else if(t.steps){for(a=p/l,u=0,s=t.steps.length;u<s&&t.steps[u]<a;++u);e=t.steps[Math.max(0,u-1)]}else{for(n=Math.ceil(Math.log(l)/c),i=t.minstep||0,e=Math.max(i,Math.pow(f,Math.round(Math.log(p)/c)-n));Math.ceil(p/e)>l;)e*=f;for(u=0,s=h.length;u<s;++u)(a=e/h[u])>=i&&p/a<=l&&(e=a)}return a=Math.log(e),r=a>=0?0:1+~~(-a/c),o=Math.pow(f,-r-1),(t.nice||void 0===t.nice)&&(d=d<(a=Math.floor(d/e+o)*e)?a-e:a,m=Math.ceil(m/e)*e),{start:d,stop:m,step:e}},cn=function(t,e){var n,i=[],r=t.length,a=-1;if(null==e)for(;++a<r;)isNaN(n=B(t[a]))||i.push(n);else for(;++a<r;)isNaN(n=B(e(t[a],a,t)))||i.push(n);return i},hn=Math.random,dn=function(t,e){return t<e?-1:t>e?1:t>=e?0:NaN},mn=function(t){return 1===t.length&&(t=G(t)),{left:function(e,n,i,r){for(null==i&&(i=0),null==r&&(r=e.length);i<r;){var a=i+r>>>1;t(e[a],n)<0?i=a+1:r=a}return i},right:function(e,n,i,r){for(null==i&&(i=0),null==r&&(r=e.length);i<r;){var a=i+r>>>1;t(e[a],n)>0?r=a:i=a+1}return i}}},pn=(mn(dn),function(t){return null===t?NaN:+t}),vn=function(t,e){var n,i,r=t.length,a=0,u=-1,s=0,o=0;if(null==e)for(;++u<r;)isNaN(n=pn(t[u]))||(o+=(i=n-s)*(n-(s+=i/++a)));else for(;++u<r;)isNaN(n=pn(e(t[u],u,t)))||(o+=(i=n-s)*(n-(s+=i/++a)));if(a>1)return o/(a-1)},gn=function(t,e){var n,i,r,a=t.length,u=-1;if(null==e){for(;++u<a;)if(null!=(n=t[u])&&n>=n)for(i=r=n;++u<a;)null!=(n=t[u])&&(i>n&&(i=n),r<n&&(r=n))}else for(;++u<a;)if(null!=(n=e(t[u],u,t))&&n>=n)for(i=r=n;++u<a;)null!=(n=e(t[u],u,t))&&(i>n&&(i=n),r<n&&(r=n));return[i,r]},yn=function(t,e,n){t=+t,e=+e,n=(r=arguments.length)<2?(e=t,t=0,1):r<3?1:+n;for(var i=-1,r=0|Math.max(0,Math.ceil((e-t)/n)),a=new Array(r);++i<r;)a[i]=t+i*n;return a},_n=function(t,e,n){if(null==n&&(n=pn),i=t.length){if((e=+e)<=0||i<2)return+n(t[0],0,t);if(e>=1)return+n(t[i-1],i-1,t);var i,r=(i-1)*e,a=Math.floor(r),u=+n(t[a],a,t);return u+(+n(t[a+1],a+1,t)-u)*(r-a)}},xn=function(t,e,n,i){var r,a,u,s,o=cn(t,i),l=o.length,f=e;for(u=0,s=Array(f);u<f;++u){for(r=0,a=0;a<l;++a)r+=o[~~(hn()*l)];s[u]=r/l}return[_n(s.sort(dn),n/2),_n(s,1-n/2)]},Dn=function(t,e){var n=cn(t,e);return[_n(n.sort(dn),.25),_n(n,.5),_n(n,.75)]},bn=function(t,e){var n,i,r=NaN,a={};return a.mean=function(t){return arguments.length?(n=t||0,r=NaN,a):n},a.stdev=function(t){return arguments.length?(i=null==t?1:t,r=NaN,a):i},a.sample=function(){var t,e,a=0,u=0;if(r===r)return a=r,r=NaN,a;do{t=(a=2*hn()-1)*a+(u=2*hn()-1)*u}while(0===t||t>1);return e=Math.sqrt(-2*Math.log(t)/t),r=n+u*e*i,n+a*e*i},a.pdf=function(t){var e=Math.exp(Math.pow(t-n,2)/(-2*Math.pow(i,2)));return 1/(i*Math.sqrt(2*Math.PI))*e},a.cdf=function(t){var e,r=(t-n)/i,a=Math.abs(r);if(a>37)e=0;else{var u=Math.exp(-a*a/2);a<7.07106781186547?(e=u*((((((.0352624965998911*a+.700383064443688)*a+6.37396220353165)*a+33.912866078383)*a+112.079291497871)*a+221.213596169931)*a+220.206867912376),e/=((((((.0883883476483184*a+1.75566716318264)*a+16.064177579207)*a+86.7807322029461)*a+296.564248779674)*a+637.333633378831)*a+793.826512519948)*a+440.413735824752):e=u/(a+1/(a+2/(a+3/(a+4/(a+.65)))))/2.506628274631}return r>0?1-e:e},a.icdf=function(t){if(t<=0||t>=1)return NaN;var e=2*t-1,r=8*(Math.PI-3)/(3*Math.PI*(4-Math.PI)),a=2/(Math.PI*r)+Math.log(1-Math.pow(e,2))/2,u=Math.log(1-e*e)/r,s=(e>0?1:-1)*Math.sqrt(Math.sqrt(a*a-u)-a);return n+i*Math.SQRT2*s},a.mean(t).stdev(e)},wn=K.prototype;wn.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},wn.add=function(t){this._add.push(t)},wn.rem=function(t){this._rem.push(t)},wn.values=function(){if(this._get=null,0===this._rem.length)return this._add;var t,e,n,i=this._add,r=this._rem,a=this._key,u=i.length,s=r.length,o=Array(u-s),l={};for(t=0;t<s;++t)l[a(r[t])]=1;for(t=0,e=0;t<u;++t)l[a(n=i[t])]?l[a(n)]=0:o[e++]=n;return this._rem=[],this._add=o},wn.distinct=function(t){for(var e,n=this.values(),i=n.length,r={},a=0;--i>=0;)e=t(n[i])+"",r.hasOwnProperty(e)||(r[e]=1,++a);return a},wn.extent=function(t){if(this._get!==t||!this._ext){var e=this.values(),n=Fe(e,t);this._ext=[e[n[0]],e[n[1]]],this._get=t}return this._ext},wn.argmin=function(t){return this.extent(t)[0]||{}},wn.argmax=function(t){return this.extent(t)[1]||{}},wn.min=function(t){var e=this.extent(t)[0];return null!=e?t(e):1/0},wn.max=function(t){var e=this.extent(t)[1];return null!=e?t(e):-1/0},wn.quartile=function(t){return this._get===t&&this._q||(this._q=Dn(this.values(),t),this._get=t),this._q},wn.q1=function(t){return this.quartile(t)[0]},wn.q2=function(t){return this.quartile(t)[1]},wn.q3=function(t){return this.quartile(t)[2]},wn.ci=function(t){return this._get===t&&this._ci||(this._ci=xn(this.values(),1e3,.05,t),this._get=t),this._ci},wn.ci0=function(t){return this.ci(t)[0]},wn.ci1=function(t){return this.ci(t)[1]},Q.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:ln},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]};var kn=Pe(Q,S);kn.transform=function(t,e){var n,i=this,r=e.fork(e.NO_SOURCE|e.NO_FIELDS);return this.stamp=r.stamp,this.value&&((n=t.modified())||e.modified(this._inputs))?(this._prev=this.value,this.value=n?this.init(t):{},e.visit(e.SOURCE,function(t){i.add(t)})):(this.value=this.value||this.init(t),e.visit(e.REM,function(t){i.rem(t)}),e.visit(e.ADD,function(t){i.add(t)})),r.modifies(this._outputs),i._drop=!1!==t.drop,t.cross&&i._dims.length>1&&(i._drop=!1,this.cross()),i.changes(r)},kn.cross=function(){function t(t){var e,n,i,s;for(e in t)for(i=t[e].tuple,n=0;n<u;++n)a[n][s=i[r[n]]]=s}function e(t,s,o){var l,f,c=r[o],h=a[o++];for(l in h)s[c]=h[l],f=t?t+"|"+l:l,o<u?e(f,s,o):i[f]||n.cell(f,s)}var n=this,i=n.value,r=n._dnames,a=r.map(function(){return{}}),u=r.length;t(n._prev),t(i),e("",{},0)},kn.init=function(t){function e(t){for(var e,n=Oe(i(t)),a=0,s=n.length;a<s;++a)u[e=n[a]]||(u[e]=1,r.push(e))}var r=this._inputs=[],a=this._outputs=[],u={};this._dims=Oe(t.groupby),this._dnames=this._dims.map(function(t){var i=n(t);return e(t),a.push(i),i}),this.cellkey=t.key?t.key:U(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];var s,o,l,f,c,h,d=t.fields||[null],m=t.ops||["count"],p=t.as||[],v=d.length,g={};for(v!==m.length&&le("Unmatched number of fields and aggregate ops."),h=0;h<v;++h)s=d[h],o=m[h],null==s&&"count"!==o&&le("Null aggregate field specified."),c=L(o,f=n(s),p[h]),a.push(c),"count"!==o?((l=g[f])||(e(s),(l=g[f]=[]).field=s,this._measures.push(l)),"count"!==o&&(this._countOnly=!1),l.push(z(o,c))):this._counts.push(c);return this._measures=this._measures.map(function(t){return W(t,t.field)}),{}},kn.cellkey=U(),kn.cell=function(t,e){var n=this.value[t];return n?0===n.num&&this._drop&&n.stamp<this.stamp?(n.stamp=this.stamp,this._adds[this._alen++]=n):n.stamp<this.stamp&&(n.stamp=this.stamp,this._mods[this._mlen++]=n):(n=this.value[t]=this.newcell(t,e),this._adds[this._alen++]=n),n},kn.newcell=function(t,e){var n={key:t,num:0,agg:null,tuple:this.newtuple(e,this._prev&&this._prev[t]),stamp:this.stamp,store:!1};if(!this._countOnly){var i,r=this._measures,a=r.length;for(n.agg=Array(a),i=0;i<a;++i)n.agg[i]=new r[i](n)}return n.store&&(n.data=new K),n},kn.newtuple=function(t,e){var n,i,r=this._dnames,a=this._dims,u={};for(n=0,i=a.length;n<i;++n)u[r[n]]=a[n](t);return e?h(e.tuple,u):l(u)},kn.add=function(t){var e,n,i,r=this.cellkey(t),a=this.cell(r,t);if(a.num+=1,!this._countOnly)for(a.store&&a.data.add(t),n=0,i=(e=a.agg).length;n<i;++n)e[n].add(e[n].get(t),t)},kn.rem=function(t){var e,n,i,r=this.cellkey(t),a=this.cell(r,t);if(a.num-=1,!this._countOnly)for(a.store&&a.data.rem(t),n=0,i=(e=a.agg).length;n<i;++n)e[n].rem(e[n].get(t),t)},kn.celltuple=function(t){var e,n,i,r=t.tuple,a=this._counts;for(t.store&&t.data.values(),n=0,i=a.length;n<i;++n)r[a[n]]=t.num;if(!this._countOnly)for(n=0,i=(e=t.agg).length;n<i;++n)e[n].set(r);return r},kn.changes=function(t){var e,n,i,r,a=this._adds,u=this._mods,s=this._prev,o=this._drop,l=t.add,f=t.rem,c=t.mod;if(s)for(n in s)e=s[n],o&&!e.num||f.push(e.tuple);for(i=0,r=this._alen;i<r;++i)l.push(this.celltuple(a[i])),a[i]=null;for(i=0,r=this._mlen;i<r;++i)(0===(e=u[i]).num&&o?f:c).push(this.celltuple(e)),u[i]=null;return this._alen=this._mlen=0,this._prev=null,t},H.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]};var On=Pe(H,S);On.transform=function(t,e){var n,r=this._bins(t),a=r.start,u=r.step,s=t.as||["bin0","bin1"],o=s[0],l=s[1];return n=t.modified()?(e=e.reflow(!0)).SOURCE:e.modified(i(t.field))?e.ADD_MOD:e.ADD,e.visit(n,function(t){var e=r(t);t[o]=e,t[l]=null==e?null:a+u*(1+(e-a)/u)}),e.modifies(s)},On._bins=function(t){if(this.value&&!t.modified())return this.value;var e,r,a=t.field,u=fn(t),s=u.start,o=u.stop,l=u.step;null!=(e=t.anchor)&&(r=e-(s+l*Math.floor((e-s)/l)),s+=r,o+=r);var f=function(t){var e=a(t);return null==e?null:(e=Math.max(s,Math.min(+e,o-l)),s+l*Math.floor((e-s)/l))};return f.start=s,f.stop=o,f.step=l,this.value=oe(f,i(a),t.name||"bin_"+n(a))};var Mn=function(t,e,n){var i=t,r=e||[],a=n||[],u={},s=0;return{add:function(t){a.push(t)},remove:function(t){u[i(t)]=++s},size:function(){return r.length},data:function(t,e){return s&&(r=r.filter(function(t){return!u[i(t)]}),u={},s=0),e&&t&&r.sort(t),a.length&&(r=t?Ue(t,r,a.sort(t)):r.concat(a),a=[]),r}}};V.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},Pe(V,S).transform=function(t,e){var n=e.fork(e.ALL),i=Mn(s,this.value,n.materialize(n.ADD).add),r=t.sort,a=e.changed()||r&&(t.modified("sort")||e.modified(r.fields));return n.visit(n.REM,i.remove),this.modified(a),this.value=n.source=i.data(r,a),n},Pe(X,v),Z.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]};var En=Pe(Z,S);En.transform=function(t,e){function n(e){return function(n){for(var i,r=tt(s(n),t.case,a)||[],o=0,l=r.length;o<l;++o)u.test(i=r[o])||e(i)}}var i=this._parameterCheck(t,e),r=this._counts,a=this._match,u=this._stop,s=t.field,o=t.as||["text","count"],l=n(function(t){r[t]=1+(r[t]||0)}),f=n(function(t){r[t]-=1});return i?e.visit(e.SOURCE,l):(e.visit(e.ADD,l),e.visit(e.REM,f)),this._finish(e,o)},En._parameterCheck=function(t,e){var n=!1;return!t.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(t.stopwords||"")+"$","i"),n=!0),!t.modified("pattern")&&this._match||(this._match=new RegExp(t.pattern||"[\\w']+","g"),n=!0),(t.modified("field")||e.modified(t.field.fields))&&(n=!0),n&&(this._counts={}),n},En._finish=function(t,e){var n,i,r,a=this._counts,u=this._tuples||(this._tuples={}),s=e[0],o=e[1],f=t.fork();for(n in a)i=u[n],r=a[n]||0,!i&&r?(u[n]=i=l({}),i[s]=n,i[o]=r,f.add.push(i)):0===r?(i&&f.rem.push(i),a[n]=null,u[n]=null):i[o]!==r&&(i[o]=r,f.mod.push(i));return f.modifies(e)},et.Definition={type:"Cross",metadata:{source:!0,generates:!0,changes:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},Pe(et,S).transform=function(t,e){var n=e.fork(e.NO_SOURCE),i=this.value,r=t.as||["a","b"],a=r[0],u=r[1];return!i||e.changed(e.ADD_REM)||t.modified("as")||t.modified("filter")?(i&&(n.rem=i),n.add=this.value=nt(e.source,a,u,t.filter||_e)):n.mod=i,n.source=this.value,n.modifies(r)};var qn={kde:function(t,e){var n=bn(),i={},r=0;return i.data=function(n){return arguments.length?(t=n,r=n?n.length:0,i.bandwidth(e)):t},i.bandwidth=function(n){return arguments.length?(!(e=n)&&t&&(e=J(t)),i):e},i.sample=function(){return t[~~(hn()*r)]+e*n.sample()},i.pdf=function(i){for(var a=0,u=0;u<r;++u)a+=n.pdf((i-t[u])/e);return a/e/r},i.cdf=function(i){for(var a=0,u=0;u<r;++u)a+=n.cdf((i-t[u])/e);return a/r},i.icdf=function(){throw Error("KDE icdf not supported.")},i.data(t)},mixture:function(t,e){function n(t){var e,n=[],i=0;for(e=0;e<a;++e)i+=n[e]=null==t[e]?1:+t[e];for(e=0;e<a;++e)n[e]/=i;return n}var i,r={},a=0;return r.weights=function(t){return arguments.length?(i=n(e=t||[]),r):e},r.distributions=function(n){return arguments.length?(n?(a=n.length,t=n):(a=0,t=[]),r.weights(e)):t},r.sample=function(){for(var e=hn(),n=t[a-1],r=i[0],u=0;u<a-1;r+=i[++u])if(e<r){n=t[u];break}return n.sample()},r.pdf=function(e){for(var n=0,r=0;r<a;++r)n+=i[r]*t[r].pdf(e);return n},r.cdf=function(e){for(var n=0,r=0;r<a;++r)n+=i[r]*t[r].cdf(e);return n},r.icdf=function(){throw Error("Mixture icdf not supported.")},r.distributions(t).weights(e)},normal:bn,uniform:function(t,e){null==e&&(e=null==t?1:t,t=0);var n,i,r,a={};return a.min=function(t){return arguments.length?(n=t||0,r=i-n,a):n},a.max=function(t){return arguments.length?(i=t||0,r=i-n,a):i},a.sample=function(){return n+r*hn()},a.pdf=function(t){return t>=n&&t<=i?1/r:0},a.cdf=function(t){return t<n?0:t>i?1:(t-n)/r},a.icdf=function(t){return t>=0&&t<=1?n+t*r:NaN},a.min(t).max(e)}},Nn="distributions",An="function",Fn="field",Rn=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],Sn={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:Rn},{name:"weights",type:"number",array:!0}]};rt.Definition={type:"Density",metadata:{generates:!0,source:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number",default:100},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:Rn.concat(Sn)},{name:"as",type:"string",array:!0,default:["value","density"]}]},Pe(rt,S).transform=function(t,e){var n=e.fork(e.NO_SOURCE|e.NO_FIELDS);if(!this.value||e.changed()||t.modified()){var i=it(t.distribution,at(e)),r=t.method||"pdf";"pdf"!==r&&"cdf"!==r&&le("Invalid density method: "+r),t.extent||i.data||le("Missing density extent parameter."),r=i[r];var a=t.as||["value","density"],u=t.extent||gn(i.data()),s=(u[1]-u[0])/(t.steps||100),o=yn(u[0],u[1]+s/2,s).map(function(t){var e={};return e[a[0]]=t,e[a[1]]=r(t),l(e)});this.value&&(n.rem=this.value),this.value=n.add=n.source=o}return n},ut.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},Pe(ut,S).transform=function(t,e){var n=this.value,i=t.field,r=n[0],a=n[1],u=e.ADD;(e.changed()||e.modified(i.fields)||t.modified("field"))&&(u=e.SOURCE,r=1/0,a=-1/0),e.visit(u,function(t){var e=i(t);null!=e&&(e<r&&(r=e),e>a&&(a=e))}),this.value=[r,a]};var Pn=Pe(st,v);Pn.connect=function(t){return this.targets().add(t),t.source=this},Pn.add=function(t){this.value.add.push(t)},Pn.rem=function(t){this.value.rem.push(t)},Pn.mod=function(t){this.value.mod.push(t)},Pn.init=function(t){this.value.init(t,t.NO_SOURCE)},Pn.evaluate=function(){return this.value};var jn=Pe(ot,S);jn.activate=function(t){this._targets[this._targets.active++]=t},jn.subflow=function(t,e,n,i){var r,a,u=this.value,s=u.hasOwnProperty(t)&&u[t];return s?s.value.stamp<n.stamp&&(s.init(n),this.activate(s)):(a=i||(a=this._group[t])&&a.tuple,s=(r=n.dataflow).add(new st(n.fork(n.NO_SOURCE),this)).connect(e(r,t,a)),u[t]=s,this.activate(s)),s},jn.transform=function(t,e){function n(t){return r.subflow(t,u,e)}var i=e.dataflow,r=this,a=t.key,u=t.subflow,o=this._keys,l=t.modified("key");return this._group=t.group||{},this._targets.active=0,e.visit(e.REM,function(t){var e=s(t),i=o.get(e);void 0!==i&&(o.delete(e),n(i).rem(t))}),e.visit(e.ADD,function(t){var e=a(t);o.set(s(t),e),n(e).add(t)}),l||e.modified(a.fields)?e.visit(e.MOD,function(t){var e=s(t),i=o.get(e),r=a(t);i===r?n(r).mod(t):(o.set(e,r),n(i).rem(t),n(r).add(t))}):e.changed(e.MOD)&&e.visit(e.MOD,function(t){n(o.get(s(t))).mod(t)}),l&&e.visit(e.REFLOW,function(t){var e=s(t),i=o.get(e),r=a(t);i!==r&&(o.set(e,r),n(i).rem(t),n(r).add(t))}),o.empty>i.cleanThreshold&&i.runAfter(o.clean),e},Pe(lt,v),ct.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},Pe(ct,S).transform=function(t,e){function n(e){var n=s(e),i=f(e,t),a=r.get(n);i&&a?(r.delete(n),u.push(e)):i||a?c&&i&&!a&&l.push(e):(r.set(n,1),o.push(e))}var i=e.dataflow,r=this.value,a=e.fork(),u=a.add,o=a.rem,l=a.mod,f=t.expr,c=!0;return e.visit(e.REM,function(t){var e=s(t);r.has(e)?r.delete(e):o.push(t)}),e.visit(e.ADD,function(e){f(e,t)?u.push(e):r.set(s(e),1)}),e.visit(e.MOD,n),t.modified()&&(c=!1,e.visit(e.REFLOW,n)),r.empty>i.cleanThreshold&&i.runAfter(r.clean),a},ht.Definition={type:"Fold",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},Pe(ht,S).transform=function(t,e){function n(t){for(var e,n=r[s(t)]=Array(m),i=0;i<m;++i)(e=n[i]=f(t))[l]=d[i],e[h]=u[i](t),v.add.push(e)}var i,r=this.value,a=t.modified("fields"),u=t.fields,o=t.as||["key","value"],l=o[0],h=o[1],d=u.map(dt),m=u.length,p=e.stamp,v=e.fork(e.NO_SOURCE),g=0,y=0;if(a){for(i in r)v.rem.push.apply(v.rem,r[i]);r=this.value={},e.visit(e.SOURCE,n)}else{for(e.visit(e.ADD,n);g<m;++g)e.modified(u[g].fields)&&(y|=1<<g);y&&e.visit(e.MOD,function(t){for(var e,n=r[s(t)],i=0;i<m;++i)y&1<<i&&((e=c(t,n[i],p))[l]=d[i],e[h]=u[i](t),v.mod.push(e))}),e.visit(e.REM,function(t){var e=s(t);v.rem.push.apply(v.rem,r[e]),r[e]=null})}return v.modifies(o)},mt.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},Pe(mt,S).transform=function(t,e){var n=t.expr,i=t.as,r=t.modified(),a=t.initonly?e.ADD:r?e.SOURCE:e.modified(n.fields)?e.ADD_MOD:e.ADD;return r&&(e=e.materialize().reflow(!0)),t.initonly||e.modifies(i),e.visit(a,function(e){e[i]=n(e,t)})},Pe(pt,S).transform=function(t,e){var n,i,r,a=this.value,u=e.fork(e.ALL),s=t.size-a.length,o=t.generator;if(s>0){for(n=[];--s>=0;)n.push(r=l(o(t))),a.push(r);u.add=u.add.length?u.materialize(u.ADD).add.concat(n):n}else i=a.slice(0,-s),u.rem=u.rem.length?u.materialize(u.REM).rem.concat(i):i,a=a.slice(-s);return u.source=this.value=a,u};var Cn={value:"value",median:function(t,e){var n,i=t.length,r=-1,a=[];if(null==e)for(;++r<i;)isNaN(n=pn(t[r]))||a.push(n);else for(;++r<i;)isNaN(n=pn(e(t[r],r,t)))||a.push(n);return _n(a.sort(dn),.5)},mean:function(t,e){var n,i=t.length,r=i,a=-1,u=0;if(null==e)for(;++a<i;)isNaN(n=pn(t[a]))?--r:u+=n;else for(;++a<i;)isNaN(n=pn(e(t[a],a,t)))?--r:u+=n;if(r)return u/r},min:function(t,e){var n,i,r=t.length,a=-1;if(null==e){for(;++a<r;)if(null!=(n=t[a])&&n>=n)for(i=n;++a<r;)null!=(n=t[a])&&i>n&&(i=n)}else for(;++a<r;)if(null!=(n=e(t[a],a,t))&&n>=n)for(i=n;++a<r;)null!=(n=e(t[a],a,t))&&i>n&&(i=n);return i},max:function(t,e){var n,i,r=t.length,a=-1;if(null==e){for(;++a<r;)if(null!=(n=t[a])&&n>=n)for(i=n;++a<r;)null!=(n=t[a])&&n>i&&(i=n)}else for(;++a<r;)if(null!=(n=e(t[a],a,t))&&n>=n)for(i=n;++a<r;)null!=(n=e(t[a],a,t))&&n>i&&(i=n);return i}},Un=[];vt.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},Pe(vt,S).transform=function(t,e){var i,r,a,u,s,o,f,c,h,d,m=e.fork(e.ALL),p=gt(t),v=yt(t),g=n(t.field),y=n(t.key),_=(t.groupby||[]).map(n),x=_t(e.source,t.groupby,t.key,t.keyvals),D=[],b=this.value,w=x.domain.length;for(s=0,c=x.length;s<c;++s)for(a=(i=x[s]).values,r=NaN,f=0;f<w;++f)if(null==i[f]){for(u=x.domain[f],d={_impute:!0},o=0,h=a.length;o<h;++o)d[_[o]]=a[o];d[y]=u,d[g]=isNaN(r)?r=p(i,v):r,D.push(l(d))}return D.length&&(m.add=m.materialize(m.ADD).add.concat(D)),b.length&&(m.rem=m.materialize(m.REM).rem.concat(b)),this.value=D,m},xt.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:ln},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]};var Ln=Pe(xt,Q);Ln.transform=function(t,e){var n,i=this,r=t.modified();return i.value&&(r||e.modified(i._inputs))?(n=i.value=r?i.init(t):{},e.visit(e.SOURCE,function(t){i.add(t)})):(n=i.value=i.value||this.init(t),e.visit(e.REM,function(t){i.rem(t)}),e.visit(e.ADD,function(t){i.add(t)})),i.changes(),e.visit(e.SOURCE,function(t){Ae(t,n[i.cellkey(t)].tuple)}),e.reflow(r).modifies(this._outputs)},Ln.changes=function(){var t,e,n=this._adds,i=this._mods;for(t=0,e=this._alen;t<e;++t)this.celltuple(n[t]),n[t]=null;for(t=0,e=this._mlen;t<e;++t)this.celltuple(i[t]),i[t]=null;this._alen=this._mlen=0},Pe(Dt,v),wt.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},Pe(wt,S).transform=function(t,e){var i,r,a=e,u=t.as,s=t.fields,o=t.index,l=t.values,f=null==t.default?null:t.default,c=t.modified(),h=c?e.SOURCE:e.ADD,d=s.length;return l?(r=l.length,d>1&&!u&&le('Multi-field lookup requires explicit "as" parameter.'),u&&u.length!==d*r&&le('The "as" parameter has too few output field names.'),u=u||l.map(n),i=function(t){for(var e,n,i=0,a=0;i<d;++i)if(null==(n=o.get(s[i](t))))for(e=0;e<r;++e,++a)t[u[a]]=f;else for(e=0;e<r;++e,++a)t[u[a]]=l[e](n)}):(u||le("Missing output field names."),i=function(t){for(var e,n=0;n<d;++n)e=o.get(s[n](t)),t[u[n]]=null==e?f:e}),c?a=e.reflow(!0):h|=s.some(function(t){return e.modified(t.fields)})?e.MOD:0,e.visit(h,i),a.modifies(u)},Pe(kt,v),Pe(Mt,v),Pe(qt,S),qt.prototype.transform=function(t,e){return this.modified(t.modified()),this.value=t,e.fork(e.NO_SOURCE|e.NO_FIELDS)},Pe(Nt,ot).transform=function(t,e){var n=this,r=t.subflow,a=t.field;return(t.modified("field")||a&&e.modified(i(a)))&&le("PreFacet does not support field modification."),this._targets.active=0,e.visit(e.MOD,function(t){var i=n.subflow(s(t),r,e,t);a?a(t).forEach(function(t){i.mod(t)}):i.mod(t)}),e.visit(e.ADD,function(t){var i=n.subflow(s(t),r,e,t);a?a(t).forEach(function(t){i.add(l(t))}):i.add(t)}),e.visit(e.REM,function(t){var i=n.subflow(s(t),r,e,t);a?a(t).forEach(function(t){i.rem(t)}):i.rem(t)}),e},At.Definition={type:"Project",metadata:{generates:!0,changes:!0,modifies:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},Pe(At,S).transform=function(t,e){var n,i,r=t.fields,a=Ft(t.fields,t.as||[]),u=r?function(t,e){return Rt(t,e,r,a)}:c;return this.value?i=this.value:(e=e.addAll(),i=this.value={}),n=e.fork(),e.visit(e.REM,function(t){var e=s(t);n.rem.push(i[e]),i[e]=null}),e.visit(e.ADD,function(t){var e=u(t,l({}));i[s(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(u(t,i[s(t)]))}),n},Pe(St,S).transform=function(t,e){return this.value=t.value,t.modified("value")?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},Pe(Pt,S).transform=function(t,e){var n,i;return this.value?i=this.value:(n=e=e.addAll(),i=this.value={}),t.derive&&(n=e.fork(),e.visit(e.REM,function(t){var e=s(t);n.rem.push(i[e]),i[e]=null}),e.visit(e.ADD,function(t){var e=f(t);i[s(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(c(t,i[s(t)]))})),n},jt.Definition={type:"Sample",metadata:{source:!0,changes:!0},params:[{name:"size",type:"number",default:1e3}]},Pe(jt,S).transform=function(t,e){function n(t){var e,n;u.length<a?u.push(t):(n=~~((o+1)*hn()))<u.length&&n>=l&&(e=u[n],f[s(e)]&&i.rem.push(e),u[n]=t),++o}var i=e.fork(),r=t.modified("size"),a=t.size,u=this.value,o=this.count,l=0,f=u.reduce(function(t,e){return t[s(e)]=1,t},{});if(e.rem.length&&(e.visit(e.REM,function(t){var e=s(t);f[e]&&(f[e]=-1,i.rem.push(t)),--o}),u=u.filter(function(t){return-1!==f[s(t)]})),(e.rem.length||r)&&u.length<a&&e.source&&(l=o=u.length,e.visit(e.SOURCE,function(t){f[s(t)]||n(t)}),l=-1),r&&u.length>a){for(var c=0,h=u.length-a;c<h;++c)f[s(u[c])]=-1,i.rem.push(u[c]);u=u.slice(h)}return e.mod.length&&e.visit(e.MOD,function(t){f[s(t)]&&i.mod.push(t)}),e.add.length&&e.visit(e.ADD,n),(e.add.length||l<0)&&(i.add=u.filter(function(t){return!f[s(t)]})),this.count=o,this.value=i.source=u,i},Ct.Definition={type:"Sequence",metadata:{generates:!0,source:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1}],output:["value"]},Pe(Ct,S).transform=function(t,e){if(!this.value||t.modified()){var n=e.materialize().fork(e.MOD);return n.rem=this.value?e.rem.concat(this.value):e.rem,n.source=this.value=yn(t.start,t.stop,t.step||1).map(l),n.add=e.add.concat(this.value),n}},Pe(Ut,S).transform=function(t,e){return this.value=e.source,e.changed()?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},Pe(Lt,S).transform=function(t,e){function n(t){a.set(r(t),t)}var i=e.dataflow,r=t.field,a=this.value,u=!0;return t.modified("field")||e.modified(r.fields)?(a.clear(),e.visit(e.SOURCE,n)):e.changed()?(e.visit(e.REM,function(t){a.delete(r(t))}),e.visit(e.ADD,n)):u=!1,this.modified(u),a.empty>i.cleanThreshold&&i.runAfter(a.clean),e.fork()},Pe(zt,S).transform=function(t,e){(!this.value||t.modified("field")||t.modified("sort")||e.changed()||t.sort&&e.modified(t.sort.fields))&&(this.value=(t.sort?e.source.slice().sort(t.sort):e.source).map(t.field))};var zn={row_number:function(){return{next:function(t){return t.index+1}}},rank:function(){var t;return{init:function(){t=1},next:function(e){var n=e.index,i=e.data;return n&&e.compare(i[n-1],i[n])?t=n+1:t}}},dense_rank:function(){var t;return{init:function(){t=1},next:function(e){var n=e.index,i=e.data;return n&&e.compare(i[n-1],i[n])?++t:t}}},percent_rank:function(){var t=zn.rank(),e=t.next;return{init:t.init,next:function(t){return(e(t)-1)/(t.data.length-1)}}},cume_dist:function(){var t;return{init:function(){t=0},next:function(e){var n=e.index,i=e.data,r=e.compare;if(t<n){for(;n+1<i.length&&!r(i[n],i[n+1]);)++n;t=n}return(1+t)/i.length}}},ntile:function(t,e){(e=+e)>0||le("ntile num must be greater than zero.");var n=zn.cume_dist(),i=n.next;return{init:n.init,next:function(t){return Math.ceil(e*i(t))}}},lag:function(t,e){return e=+e||1,{next:function(n){var i=n.index-e;return i>=0?t(n.data[i]):null}}},lead:function(t,e){return e=+e||1,{next:function(n){var i=n.index+e,r=n.data;return i<r.length?t(r[i]):null}}},first_value:function(t){return{next:function(e){return t(e.data[e.i0])}}},last_value:function(t){return{next:function(e){return t(e.data[e.i1-1])}}},nth_value:function(t,e){return(e=+e)>0||le("nth_value nth must be greater than zero."),{next:function(n){var i=n.i0+(e-1);return i<n.i1?t(n.data[i]):null}}}},In=Object.keys(zn),$n=$t.prototype;$n.init=function(){this.windows.forEach(function(t){t.init()}),this.cell&&this.cell.init()},$n.update=function(t,e){var n,i=this,r=i.cell,a=i.windows,u=t.data,s=a&&a.length;if(r){for(n=t.p0;n<t.i0;++n)r.rem(u[n]);for(n=t.p1;n<t.i1;++n)r.add(u[n]);r.set(e)}for(n=0;n<s;++n)a[n].update(t,e)},Wt.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:In.concat(ln)},{name:"params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]};var Tn=Pe(Wt,S);Tn.transform=function(t,e){function n(t){return a.group(o(t))}var i,r,a=this,u=a.state,s=t.modified();this.stamp=e.stamp,u&&!s||(u=a.state=new $t(t));var o=U(t.groupby);for(s||e.modified(u.inputs)?(a.value={},e.visit(e.SOURCE,function(t){n(t).add(t)})):(e.visit(e.REM,function(t){n(t).remove(t)}),e.visit(e.ADD,function(t){n(t).add(t)})),i=0,r=a._mlen;i<r;++i)Bt(a._mods[i],u,t);return a._mlen=0,a._mods=[],e.reflow(s).modifies(u.outputs)},Tn.group=function(t){var e=this,n=e.value[t];return n||((n=e.value[t]=Mn(s)).stamp=-1),n.stamp<e.stamp&&(n.stamp=e.stamp,e._mods[e._mlen++]=n),n};var Wn=Object.freeze({aggregate:Q,bin:H,collect:V,compare:X,countpattern:Z,cross:et,density:rt,extent:ut,facet:ot,field:lt,filter:ct,fold:ht,formula:mt,generate:pt,impute:vt,joinaggregate:xt,key:Dt,lookup:wt,multiextent:kt,multivalues:Mt,params:qt,prefacet:Nt,project:At,proxy:St,relay:Pt,sample:jt,sequence:Ct,sieve:Ut,subflow:st,tupleindex:Lt,values:zt,window:Wt});const Bn="ascending",Gn="descending",Jn=Ie(Q.Definition.params[1].values),Kn=Ie(Wt.Definition.params[2].values),Qn={array:t=>{const e=t.length,n=t.name,i=Qn[t.type];return r=>(ce(r)||le(`Expected array parameter: ${n}.`),null!=e&&r.length!==e&&le(`Expected array of length ${e}: ${n}.`),r.map(i(t)))},compare:t=>e=>{let n=e;return n&&Me(n.toObject)&&(n=n.toObject()),de(n)&&(n=Oe(n)),ce(n)&&(n=Ht(n)),he(n)&&!Me(n)?Me(n.accessor)?oe(n.accessor,n.fields):Ee(n.fields,n.orders):le(`Unrecognized comparator value for parameter: ${t.name}.`)},enum:t=>{const e=Ie(t.values);return n=>e[n]?n:le(`Invalid parameter value '${n+""}' for ${t.name}. Must be one of [${t.values}].`)},expr:t=>e=>Vt(e)||le(`Invalid parameter value '${e+""}' for ${t.name}.`),field:t=>e=>Xt(e)||le(`Invalid parameter value '${e+""}' for ${t.name}.`),measure:()=>t=>Yt(t,Jn),window:()=>t=>Yt(t,Kn),boolean:()=>Le,number:()=>ke,regexp:()=>Qt,string:()=>ze};var Hn=function(t,e){let n=(e=Oe(e)).length,i=t.type.toLowerCase(),r=t.params,a=t.metadata;return function(){let t,u=Zt(i,r,a),s=0;for(;s<n;++s)void 0!==(t=arguments[s])&&u[e[s]](t);return u}};const Vn=Ae({},V.Definition);Vn.params=P(Vn.params,["sort"]);var Xn=Hn(Vn);const Yn=Symbol("dataflow-output");const Zn=Ae({},Q.Definition);Zn.params=P(Zn.params,["ops","fields","as"]),Zn.params.push({name:"measure",type:"measure",proxy:!0});var ti=Hn(Zn,["groupby","measure"]);const ei=Ae({},H.Definition);ei.params=j(ei.params,{extent:{init:{type:"extent",params:{field:"field"}}}});var ni=Hn(ei,"field");const ii=Ae({},Z.Definition);ii.params=j(ii.params,{pattern:{type:"regexp"},stopwords:{type:"regexp"}});var ri=Hn(ii,["field","pattern","case"]),ai=Hn(ct.Definition,"expr"),ui=Hn(ht.Definition,"fields"),si=Hn(mt.Definition,["as","expr"]);const oi=Ae({},xt.Definition);oi.params=P(oi.params,["ops","fields","as"]),oi.params.push({name:"measure",type:"measure",proxy:!0});var li=Hn(oi,["groupby","measure"]);const fi=Ae({},At.Definition);fi.params=P(fi.params,["as"]);var ci=Hn(fi,["fields"]),hi=Hn(jt.Definition,"size");const di=Ae({},V.Definition);di.params=j(di.params,{sort:{alias:"compare"}});var mi=Hn(di,"compare");const pi=Ae({},Wt.Definition);pi.params=P(pi.params,["ops","fields","as","params"]),pi.params=j(pi.params,{sort:{alias:"compare"}}),pi.params.push({name:"measure",type:"window",proxy:!0});var vi=Hn(pi,["compare","frame","measure"]);const gi=ae("count"),yi=ae("row_number"),_i=ae("rank"),xi=ae("dense_rank"),Di=ae("percent_rank"),bi=ae("cume_dist"),wi=ue("valid"),ki=ue("missing"),Oi=ue("distinct"),Mi=ue("min"),Ei=ue("max"),qi=ue("argmin"),Ni=ue("argmax"),Ai=ue("sum"),Fi=ue("mean"),Ri=ue("average"),Si=ue("variance"),Pi=ue("variancep"),ji=ue("stdev"),Ci=ue("stdevp"),Ui=ue("stderr"),Li=ue("median"),zi=ue("q1"),Ii=ue("q3"),$i=ue("ci0"),Ti=ue("ci1"),Wi=ue("first_value"),Bi=ue("last_value"),Gi=se("lag"),Ji=se("lead"),Ki=se("nth_value"),Qi=function(t){return e=>ie({op:t},"param").param(e)}("ntile");t.dataflow=function(t,e){return arguments.length<2?ne(null,t):ne(t,e)},t.aggregate=ti,t.bin=ni,t.countpattern=ri,t.filter=ai,t.fold=ui,t.formula=si,t.joinaggregate=li,t.project=ci,t.sample=hi,t.sort=mi,t.window=vi,t.field=(t=>ie({field:t})),t.expr=(t=>ie({accessor:t},"fields")),t.count=gi,t.row_number=yi,t.rank=_i,t.dense_rank=xi,t.percent_rank=Di,t.cume_dist=bi,t.valid=wi,t.missing=ki,t.distinct=Oi,t.min=Mi,t.max=Ei,t.argmin=qi,t.argmax=Ni,t.sum=Ai,t.mean=Fi,t.average=Ri,t.variance=Si,t.variancep=Pi,t.stdev=ji,t.stdevp=Ci,t.stderr=Ui,t.median=Li,t.q1=zi,t.q3=Ii,t.ci0=$i,t.ci1=Ti,t.first_value=Wi,t.last_value=Bi,t.lag=Gi,t.lead=Ji,t.nth_value=Ki,t.ntile=Qi,Object.defineProperty(t,"__esModule",{value:!0})});