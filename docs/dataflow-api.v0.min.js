!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("vega-transforms")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","vega-transforms"],t):t(e.df=e.df||{},e.vega,e.vega,e.vega.transforms)}(this,function(e,t,r,n){"use strict";function a(e,t){return t=r.toSet(r.array(t)),e.filter(e=>!t[e.name])}function i(e,t){return e.map(e=>{let n=e.name;return t[n]?r.extend({},e,t[n]):e})}function o(e){const t=e.array?"array":e.type;return S[t](e)}function s(e){if(r.isRegExp(e)){let t=e+"",r=t.lastIndexOf("/");return t.slice(1,r)}return r.toString(e)}function u(e){const t=[],n=[];return e.forEach(function(e){e&&r.isString(e)||r.error(`Invalid comparator field: '${e+""}'.`);let a=j;"-"===e[0]?(a=_,e=e.slice(1)):"+"===e[0]&&(e=e.slice(1)),t.push(e),n.push(a)}),{fields:t,orders:n}}function l(e){return e&&r.isFunction(e.toObject)&&(e=e.toObject()),r.isObject(e)&&!r.isFunction(e)?r.accessor(e.accessor,e.fields,e.as):null}function c(e){return e&&r.isFunction(e.toObject)&&(e=e.toObject()),r.isString(e)?r.field(e):r.isObject(e)&&!r.isFunction(e)?r.isFunction(e.accessor)?r.accessor(e.accessor,e.fields,e.as):r.field(e.field,e.as):null}function f(e,t){let n=[],a=[],i=[],o=[];for(let s of e){r.isFunction(s.toObject)&&(s=s.toObject());let e=r.toString(s.op);t.hasOwnProperty(e)||r.error(`Invalid operation: ${e}.`),n.push(e),o.push(r.toNumber(s.param)),a.push(c(s.field)),i.push(s.as?r.toString(s.as):null)}return o.every(e=>null==e)?{ops:n,fields:a,as:i}:{ops:n,fields:a,as:i,params:o}}function p(e,t,r){const n={},a={create:(r,a)=>m(r,a,e,t,n),metadata:()=>r};return d(a,t,n),a}function m(e,t,a,i,o){let s=r.extend({},t);for(let a of i){let i=a.name,u=o[a.alias||a.name],l=void 0!==u;if(a.init&&!l){let u=r.extend({},t);for(let e in a.init.params)u[e]=o[a.init.params[e]];s[i]=e.add(n[a.init.type],u)}else if(l)if(a.proxy)for(let e in u)s[e]=u[e];else s[i]=u}return e.add(n[a],s)}function d(e,t,r){for(let n of t){const t=n.alias||n.name,a=o(n);e[t]=function(n){return arguments.length?(r[t]=a(n),e):r[t]}}}function g(e,t){let a=null,i=null,o=null;const s={[I]:()=>i,values:function(){return o.value},on:e=>(w.addDataListener(o,e),s),off:e=>(w.removeDataListener(o,e),s)};return e||(s.insert=function(e){return w.pulse(a,w.changeset().insert(e)).run(),s},s.remove=function(e){return w.pulse(a,w.changeset().remove(e)).run(),s}),function(t){let s,u,l,c,f,p,m,d,g=!0,v=[q()];for(s=0,u=t.length;s<u;++s)c=(l=t[s]).metadata(),g||c.source||(g=!0,v.push(q())),v.push(l),c.generates&&(f=!0),c.modifies&&!f&&(p=!0),c.source?g=!0:c.changes&&(g=!1);for(g||v.push(q()),e&&(1===(m=r.array(e).map(e=>e[I]())).length&&(m=m[0]),d=w.add(n.relay,{derive:p,pulse:m})),s=0,u=v.length;s<u;++s)m={pulse:d},d=v[s].create(w,m),0===s&&(a=d);i=d,o=w.add(n.sieve,{pulse:d}),w.run()}(r.array(t)),s}function v(e){const t=e||{},r={toObject:()=>t};y(r,t,"as");for(let e=1,n=arguments.length;e<n;++e)y(r,t,arguments[e]);return r}function y(e,t,r){e[r]=function(n){return arguments.length?(t[r]=n,e):t[r]}}function x(e){return()=>v({op:e})}function h(e){return t=>v({op:e},"field").field(t)}function b(e){return(t,r)=>v({op:e},"field","param").field(t).param(r)}const w=(new t.Dataflow).logLevel(r.Warn);let D=[];w.addDataListener=function(e,t){D.push({op:e,fn:t})},w.removeDataListener=function(e,t){let r=null;for(let n of D)if(n.op===e&&n.fn===t){r=n;break}r&&(D=D.filter(e=>e!==r))},w._onrun=function(){let e=w.stamp(),t=D.filter(t=>t.op.stamp===e);t.length&&setTimeout(function(){t.forEach(e=>e.fn(e.op.value))},0)};const j="ascending",_="descending",O=r.toSet(n.aggregate.Definition.params[1].values),$=r.toSet(n.window.Definition.params[2].values),S={array:e=>{const t=e.length,n=e.name,a=S[e.type];return i=>(r.isArray(i)||r.error(`Expected array parameter: ${n}.`),null!=t&&i.length!==t&&r.error(`Expected array of length ${t}: ${n}.`),i.map(a(e)))},compare:e=>t=>{let n=t;return n&&r.isFunction(n.toObject)&&(n=n.toObject()),r.isString(n)&&(n=r.array(n)),r.isArray(n)&&(n=u(n)),r.isObject(n)&&!r.isFunction(n)?r.isFunction(n.accessor)?r.accessor(n.accessor,n.fields):r.compare(n.fields,n.orders):r.error(`Unrecognized comparator value for parameter: ${e.name}.`)},enum:e=>{const t=r.toSet(e.values);return n=>t[n]?n:r.error(`Invalid parameter value '${n+""}' for ${e.name}. Must be one of [${e.values}].`)},expr:e=>t=>l(t)||r.error(`Invalid parameter value '${t+""}' for ${e.name}.`),field:e=>t=>c(t)||r.error(`Invalid parameter value '${t+""}' for ${e.name}.`),measure:()=>e=>f(e,O),window:()=>e=>f(e,$),boolean:()=>r.toBoolean,number:()=>r.toNumber,regexp:()=>s,string:()=>r.toString};var F=function(e,t){let n=(t=r.array(t)).length,a=e.type.toLowerCase(),i=e.params,o=e.metadata;return function(){let e,r=p(a,i,o),s=0;for(;s<n;++s)void 0!==(e=arguments[s])&&r[t[s]](e);return r}};const k=r.extend({},n.collect.Definition);k.params=a(k.params,["sort"]);var q=F(k);const I=Symbol("dataflow-output");const L=r.extend({},n.aggregate.Definition);L.params=a(L.params,["ops","fields","as"]),L.params.push({name:"measure",type:"measure",proxy:!0});var E=F(L,["groupby","measure"]);const z=r.extend({},n.bin.Definition);z.params=i(z.params,{extent:{init:{type:"extent",params:{field:"field"}}}});var A=F(z,"field");const M=r.extend({},n.countpattern.Definition);M.params=i(M.params,{pattern:{type:"regexp"},stopwords:{type:"regexp"}});var N=F(M,["field","pattern","case"]),P=F(n.filter.Definition,"expr"),B=F(n.fold.Definition,"fields"),C=F(n.formula.Definition,["as","expr"]);const R=r.extend({},n.joinaggregate.Definition);R.params=a(R.params,["ops","fields","as"]),R.params.push({name:"measure",type:"measure",proxy:!0});var T=F(R,["groupby","measure"]);const U=r.extend({},n.project.Definition);U.params=a(U.params,["as"]);var W=F(U,["fields"]),G=F(n.sample.Definition,"size");const H=r.extend({},n.collect.Definition);H.params=i(H.params,{sort:{alias:"compare"}});var J=F(H,"compare");const K=r.extend({},n.window.Definition);K.params=a(K.params,["ops","fields","as","params"]),K.params=i(K.params,{sort:{alias:"compare"}}),K.params.push({name:"measure",type:"window",proxy:!0});var Q=F(K,["compare","frame","measure"]);const V=x("count"),X=x("row_number"),Y=x("rank"),Z=x("dense_rank"),ee=x("percent_rank"),te=x("cume_dist"),re=h("valid"),ne=h("missing"),ae=h("distinct"),ie=h("min"),oe=h("max"),se=h("argmin"),ue=h("argmax"),le=h("sum"),ce=h("mean"),fe=h("average"),pe=h("variance"),me=h("variancep"),de=h("stdev"),ge=h("stdevp"),ve=h("stderr"),ye=h("median"),xe=h("q1"),he=h("q3"),be=h("ci0"),we=h("ci1"),De=h("first_value"),je=h("last_value"),_e=b("lag"),Oe=b("lead"),$e=b("nth_value"),Se=function(e){return t=>v({op:e},"param").param(t)}("ntile");e.dataflow=function(e,t){return arguments.length<2?g(null,e):g(e,t)},e.aggregate=E,e.bin=A,e.countpattern=N,e.filter=P,e.fold=B,e.formula=C,e.joinaggregate=T,e.project=W,e.sample=G,e.sort=J,e.window=Q,e.field=(e=>v({field:e})),e.expr=(e=>v({accessor:e},"fields")),e.count=V,e.row_number=X,e.rank=Y,e.dense_rank=Z,e.percent_rank=ee,e.cume_dist=te,e.valid=re,e.missing=ne,e.distinct=ae,e.min=ie,e.max=oe,e.argmin=se,e.argmax=ue,e.sum=le,e.mean=ce,e.average=fe,e.variance=pe,e.variancep=me,e.stdev=de,e.stdevp=ge,e.stderr=ve,e.median=ye,e.q1=xe,e.q3=he,e.ci0=be,e.ci1=we,e.first_value=De,e.last_value=je,e.lag=_e,e.lead=Oe,e.nth_value=$e,e.ntile=Se,Object.defineProperty(e,"__esModule",{value:!0})});